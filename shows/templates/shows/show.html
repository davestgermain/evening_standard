{% extends "base.html" %}
{% load wagtailcore_tags %}

{% block extra_css %}
<!-- <link rel = "stylesheet" href = "//cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" /> -->
<style>
    li.recording-item {
        cursor: pointer;
    }
</style>
{% endblock %}

{% block body_class %}show-page{% endblock %}

{% block content %}
<div class="columns">
    <div class="column has-text-centered">
        <h1 class="title is-2">{{page.start|date:"l, F jS"}}</h1>
        {% if not page.is_past %}<h2 class="subtitle is-2">{{page.start|date:"P"}}</h2>{% endif %}
        <h2 class="subtitle is-2"><a href="{{page.venue.best_url}}" target="_new">{{page.venue}}</a></h1>
        <h2 class="subtitle is-3">{{page.venue.city}}, {{page.venue.state}}</h2>
        {% if not page.is_past %}
        <h3 class="subtitle is-4"><a href="{{page.venue.map_url}}" target="_new">Directions</a></h3>
        {% endif %}

        {% if page.body %}
        <hr>
        {{ page.body|richtext }}
        {% endif %}
    </div>

    {% if page.recordings or not user.is_anonymous %}
    <div class="column is-three-fifths">
        {% if page.recordings %}
        <div class="box">
            <h3 id="currently-playing" class="subtitle"></h3>
            <audio class="media" id="player" src="" controls="controls" autoplay="autoplay" align="" data-track="0"></audio>
            <ul id="playlist" class="content pl-2 pt-3">
                {% for recording in page.get_recording_docs %}
                <li class="recording-item has-background-light" data-src="{{recording.url}}" title="{{recording.title}}">
                    <a href="{{recording.url}}" title="download">&darr;</a>
                    <span class="track has-text-success-dark" onclick="playTrack({{forloop.counter0}}, true)">{{recording.title}}</span> 
                </li>
                {% endfor %}
            </ul>

            <script type="text/javascript">
                var currently_playing = document.getElementById('currently-playing');
                var player = document.getElementById('player');
                function playTrack(track, play) {
                    let item = document.getElementById('playlist').children[track];
                    player.src = item.getAttribute('data-src');
                    player.load();
                    if (play) {
                        player.play();
                    }
                    player.setAttribute('data-track', track);
                    currently_playing.innerText = item.title;
                }
                function setup() {
                    var nodes = document.getElementById('playlist').children;

                    player.addEventListener('ended', function() {
                        let track = parseInt(player.getAttribute('data-track'));
                        track++;
                        if (track == nodes.length)
                        {
                            track = 0;
                        }
                        playTrack(track, true);
                        }, false);
                    playTrack(0, false);
                }
                setup();
            </script>

        </div>
        <hr>
        {% endif %}
    {% endif %}
        {% if page.set_list and not user.is_anonymous %}
    <h3 class="subtitle mt-4"><a href="/setlist/{{page.set_list.id}}/">Set List</a></h3>
    <ol class=" ml-4">
        {% for song in page.set_list.songs.all %}
        <li>{{song}} {% for chart in song.charts.all %}<a href="{{chart.file.url}}">{{forloop.counter}}</a> {% endfor %}</li>
        {% endfor %}
    </ol>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<!--
<script src = "//cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script>
 // Creating map options
 var mapOptions = {
 center: [42.3601, -71.88202],
 zoom: 16
 }
 var map = new L.map('my-map', mapOptions);
 
 var layer = new  L.TileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
 
 map.addLayer(layer);
 </script>
-->
{% endblock %}